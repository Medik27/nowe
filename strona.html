<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Drive File Manager</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>
    <h2>Google Drive File Manager</h2>

    <div id="g_id_onload"
         data-client_id="450078084150-19ru1ieopr4nj4vo5d338lgn8aln2pnp.apps.googleusercontent.com"
         data-auto_prompt="false"
         data-callback="handleCredentialResponse">
    </div>

    <button id="login-btn" onclick="startLogin()">Log in with Google</button>
    <button id="logout-btn" onclick="signOut()" style="display:none;">Log out</button>

    <br><br>

    <input type="file" id="file-input" />
    <button onclick="uploadFile()">Upload File</button>
    <button onclick="listFiles()">List Files</button>

    <ul id="file-list"></ul>

    <script>
        const CLIENT_ID = '450078084150-qs3ft6f5bok02dehkl5665tpimfjanr2.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyCPdcaIxxkxuGvrBBS4EUS2S5yyw81GVow';
        const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
        const SCOPES = "https://www.googleapis.com/auth/drive.file";

        let accessToken = null;

        function startLogin() {
            google.accounts.id.prompt();
        }

        function handleCredentialResponse(response) {
            console.log("Google One Tap response:", response);
            document.getElementById("login-btn").style.display = "none";
            document.getElementById("logout-btn").style.display = "block";
            loadGoogleAPI();
        }

        function signOut() {
            google.accounts.id.disableAutoSelect();
            accessToken = null;
            document.getElementById("login-btn").style.display = "block";
            document.getElementById("logout-btn").style.display = "none";
            alert("Logged out successfully!");
        }

        function loadGoogleAPI() {
            gapi.load('client', () => {
                gapi.client.init({
                    apiKey: API_KEY,
                    discoveryDocs: DISCOVERY_DOCS,
                }).then(() => {
                    console.log("Google API initialized.");
                }).catch(error => {
                    console.error("Google API initialization error:", error);
                });
            });
        }

        function uploadFile() {
            const fileInput = document.getElementById('file-input');
            const file = fileInput.files[0];

            if (!file) {
                alert("Please select a file to upload.");
                return;
            }

            if (!accessToken) {
                alert("Please log in first.");
                return;
            }

            const metadata = {
                name: file.name,
                mimeType: file.type,
            };

            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            form.append('file', file);

            fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                method: 'POST',
                headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }),
                body: form
            })
            .then(response => response.json())
            .then(data => {
                alert("File Uploaded: " + data.name);
                listFiles();
            })
            .catch(error => {
                console.error("Error uploading file:", error);
                alert("Error uploading file. Check console for details.");
            });
        }

        function listFiles() {
            if (!accessToken) {
                alert("Please log in first.");
                return;
            }

            gapi.client.drive.files.list({
                pageSize: 10,
                fields: "files(id, name)"
            }).then(response => {
                const files = response.result.files;
                const fileList = document.getElementById('file-list');
                fileList.innerHTML = '';

                if (!files || files.length === 0) {
                    fileList.innerHTML = "<li>No files found.</li>";
                    return;
                }

                files.forEach(file => {
                    let li = document.createElement('li');
                    li.innerHTML = `<a href="https://drive.google.com/uc?id=${file.id}" target="_blank">${file.name}</a>`;
                    fileList.appendChild(li);
                });
            }).catch(error => {
                console.error("Error listing files:", error);
                alert("Error listing files. Check console for details.");
            });
        }

    </script>
</body>
</html>
