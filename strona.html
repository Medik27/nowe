<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="google-site-verification" content="At5JYD1ScFBstPA0SkIezdaMSU4g_oqSScQA6UJGKqc" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Drive File Manager</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>
    <h2>Google Drive File Manager</h2>

    <button id="login-btn" onclick="authenticate()">Log in with Google</button>
    <button id="logout-btn" onclick="signOut()" style="display:none;">Log out</button>

    <br><br>

    <input type="file" id="file-input" />
    <button onclick="uploadFile()">Upload File</button>
    <button onclick="listFiles()">List Files</button>
    <button onclick="resetPermissions()">Resetuj uprawnienia</button>

    <ul id="file-list"></ul>

    <script>
        const CLIENT_ID = '450078084150-qs3ft6f5bok02dehkl5665tpimfjanr2.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyCPdcaIxxkxuGvrBBS4EUS2S5yyw81GVow';
        const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
const SCOPES = "https://www.googleapis.com/auth/drive.metadata.readonly";

        let accessToken = null;
        let tokenClient;

function authenticate() {
    tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        prompt: 'consent', // Wymusza ponowne zapytanie o uprawnienia
        callback: (response) => {
            if (response.access_token) {
                accessToken = response.access_token;
                document.getElementById("login-btn").style.display = "none";
                document.getElementById("logout-btn").style.display = "block";
                loadGoogleAPI();
            } else {
                alert("Logowanie nie powiodło się.");
            }
        }
    });

    tokenClient.requestAccessToken();
}

        function resetPermissions() {
    google.accounts.oauth2.revoke(accessToken, () => {
        alert("Uprawnienia zostały zresetowane. Zaloguj się ponownie.");
        accessToken = null;
        document.getElementById("login-btn").style.display = "block";
        document.getElementById("logout-btn").style.display = "none";
    });
}

        function signOut() {
            google.accounts.id.disableAutoSelect();
            accessToken = null;
            document.getElementById("login-btn").style.display = "block";
            document.getElementById("logout-btn").style.display = "none";
            alert("Wylogowano pomyślnie!");
        }

        function loadGoogleAPI() {
            gapi.load('client', () => {
                gapi.client.init({
                    apiKey: API_KEY,
                    discoveryDocs: DISCOVERY_DOCS,
                }).then(() => {
                    console.log("Google API zainicjalizowane.");
                }).catch(error => {
                    console.error("Błąd inicjalizacji Google API:", error);
                });
            });
        }

        function uploadFile() {
            const fileInput = document.getElementById('file-input');
            const file = fileInput.files[0];

            if (!file) {
                alert("Proszę wybrać plik do przesłania.");
                return;
            }

            if (!accessToken) {
                alert("Proszę się zalogować.");
                return;
            }

            const metadata = {
                name: file.name,
                mimeType: file.type,
            };

            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            form.append('file', file);

            fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                method: 'POST',
                headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }),
                body: form
            })
            .then(response => response.json())
            .then(data => {
                alert("Plik przesłany: " + data.name);
                listFiles();
            })
            .catch(error => {
                console.error("Błąd przesyłania pliku:", error);
                alert("Błąd przesyłania pliku. Sprawdź konsolę.");
            });
        }

        function listFiles() {
            if (!accessToken) {
                alert("Proszę się zalogować.");
                return;
            }

gapi.client.drive.files.list({
    pageSize: 10,
    fields: "files(id, name, owners)",
    q: "'me' in owners" // Pobiera tylko pliki należące do użytkownika
}).then(response => {
    const files = response.result.files;
    console.log("Znalezione pliki:", files);
});

                if (!files || files.length === 0) {
                    fileList.innerHTML = "<li>Brak plików.</li>";
                    return;
                }

                files.forEach(file => {
                    let li = document.createElement('li');
                    li.innerHTML = `<a href="https://drive.google.com/uc?id=${file.id}" target="_blank">${file.name}</a>`;
                    fileList.appendChild(li);
                });
            }).catch(error => {
                console.error("Błąd listowania plików:", error);
                alert("Błąd listowania plików. Sprawdź konsolę.");
            });
        }
    </script>
</body>
</html>
